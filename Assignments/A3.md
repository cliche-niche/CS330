### Preliminaries

Study the implementation of spinlock and sleeplock in xv6. The relevant codes are in A3/xv6-riscv/kernel/spinlock.{[h](../A3/xv6-riscv/kernel/spinlock.h),[c](../A3/xv6-riscv/kernel/spinlock.c)} and sleeplock.{[h](../A3/xv6-riscv/kernel/sleeplock.h),[c](../A3/xv6-riscv/kernel/sleeplock.c)}. Pay attention to the `acquire`, `release`, `acquiresleep`, and `releasesleep` functions. While the spinlock implements a busy-wait loop in `acquire`, the sleeplock puts the waiting processes to sleep in `acquiresleep` function. Note how a process is put to sleep using the `sleep` function and woken up later using the `wakeup` function. You will be using the same mechanism in the condition variable and semaphore implementation. In all your implementations, you should use `sleeplock` only.

### Condition Variable Implementation

Define the condition variable of type `cond_t` in a new file named [condvar.h](../A3/xv6-riscv/kernel/condvar.h). Think about what this type should be. In another new file [condvar.c](../A3/xv6-riscv/kernel/condvar.c) implement the following three functions.

```c
void cond_wait (cond_t *cv, struct sleeplock *lock)
void cond_signal (cond_t *cv)
void cond_broadcast (cond_t *cv)
```

Since the `sleep(...)` function takes one `void*` argument and a `spinlock*` argument, you will have to implement a new sleep function (you may name it `condsleep`) which takes a `cond_t*` and a `sleeplock*` argument. This function will be needed to implement `cond_wait`. The condsleep function should be implemented in [proc.c](../A3/xv6-riscv/kernel/proc.c). 

Note that the `wakeup` function wakes up all processes that are waiting on a channel (a channel is essentially a pointer). To wake up just one process (needed to implement `cond_signal`), you will have to implement a new function `wakeupone(...)` in [proc.c](../A3/xv6-riscv/kernel/proc.c). This function will be almost identical to the `wakeup` function except that it will return as soon as it encounters one process waiting on the channel. Include `condvar.o` in the `OBJS` list of [Makefile](../A3/xv6-riscv/Makefile). Also, include all new function prototypes in [defs.h](../A3/xv6-riscv/kernel/defs.h) for smooth compilation. These include `cond_wait`, `cond_signal`, `cond_broadcast`, `condsleep`, and `wakeupone`.

### Semaphore Implementation

You will implement the semaphore using condition variables and sleeplocks. This implementation is available in the lecture slides. Define the semaphore structure in a new file named [semaphore.h](../A3/xv6-riscv/kernel/semaphore.h). In another new file [semaphore.c](../A3/xv6-riscv/kernel/semaphore.c) implement the following three functions.

```c
void sem_init (struct semaphore *s, int x)
void sem_wait (struct semaphore *s)
void sem_post (struct semaphore *s)
```

### Testing Condition Variable Implementation
TBD.

### Testing Semaphore Implementation
TBD.